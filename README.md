# ShopScraper - 商品管理システム

オンラインショップの商品情報を効率的に管理し、Amazon販売における利益計算を自動化するシステムです。

## 🚀 主な機能

### 📊 商品情報管理
- **自動スクレイピング**: DHC・VT Cosmetics公式サイトから商品情報を自動取得
- **リアルタイム更新**: 最新の価格・セール情報を定期的に取得
- **高度な検索・フィルタリング**: 商品名、価格、セール状況、ASIN有無での絞り込み
- **並び替え機能**: 商品名、価格、更新日時、メモでの昇順・降順並び替え

### 💰 利益計算システム
- **ショップ別価格計算**: 
  - **VT Cosmetics**: 価格から400円引きで仕入れ価格を計算
  - **DHC**: セール価格から20%基本割引 + ユーザー設定割引（0-50%）
- **複数ASIN対応**: 1つの商品に対して複数のASINを登録・管理
- **個別利益計算**: 各ASINごとに利益額、利益率、ROI（投資収益率）を自動計算
- **制約管理**: 危険物・パートナーキャリア不可フラグの個別管理

### 📈 ダッシュボード
- **KPI表示**: 総商品数、アクティブショップ数、セール商品数
- **アクティビティ監視**: スクレイピング履歴、価格変動の追跡
- **グラフ表示**: 商品数推移、アクティビティチャート

### 🔧 高度なテーブル機能
- **列幅調整**: 各列の境界をドラッグして幅を自由に調整
- **固定ヘッダー**: スクロール時もヘッダーが常に表示
- **並び替え**: 列ヘッダークリックで昇順・降順切り替え
- **検索・フィルタリング**: 
  - 商品名・メモでの全文検索
  - 価格範囲指定
  - 危険物・パートナーキャリア不可フィルター
  - ASIN有無フィルター
  - 非表示商品表示切り替え

### 🏷️ ASIN管理
- **複数ASIN登録**: 1つの商品に対して複数のASINを登録可能
- **手動・一括登録**: 商品テーブルでの個別ASIN入力 + Excel/CSVファイルからの大量ASIN登録
- **自動情報取得**: ASIN入力時の商品情報・手数料自動取得
- **エラーハンドリング**: ASIN情報が見つからない場合の自動フォールバック
- **制約フラグ管理**: 
  - **危険物**: FBA納品不可商品（赤色表示）
  - **パートナーキャリア不可**: パートナーキャリア利用不可商品（オレンジ色表示）

## 🌐 プロキシ設定

### 環境変数設定

`.env.local` ファイルを作成し、以下の設定を行ってください：

```bash
# プロキシを使用する場合（本番環境）
USE_PROXY=true
PROXY_SERVER=http://150.61.8.70:10080
PROXY_USER=your_username
PROXY_PASS=your_password

# プロキシを使用しない場合（開発環境）
USE_PROXY=false
```

### プロキシ切り替え方法

1. **開発時（プロキシなし）**:
   ```bash
   USE_PROXY=false
   ```
   - 高速なローカル開発が可能
   - 外部プロキシサーバーへの依存なし

2. **本番環境（プロキシあり）**:
   ```bash
   USE_PROXY=true
   ```
   - IPブロック回避
   - 安定したスクレイピング実行

3. **設定変更後**: 
   ```bash
   npm run dev  # 開発サーバー再起動
   ```

### プロキシ状態確認

- **視覚的確認**: 各ショップページのプロキシ状態インジケーター
- **接続テスト**: 現在のIP・接続状態をリアルタイム確認
- **API確認**: `/api/proxy-status` エンドポイントで詳細情報取得

## 📦 セットアップ

### 1. 依存関係インストール
```bash
npm install
```

### 2. 環境変数設定
```bash
# サンプルファイルをコピー
cp .env.example .env.local

# .env.local を編集してプロキシ設定
nano .env.local
```

### 3. 開発サーバー起動
```bash
npm run dev
```

### 4. ブラウザでアクセス
```
http://localhost:3000
```

## 🛠️ 開発ガイド

### ディレクトリ構造
```
src/
├── app/                    # Next.js App Router
│   ├── api/               # API Routes
│   │   ├── products/      # 商品関連API
│   │   ├── scraping/      # スクレイピングAPI
│   │   ├── asin-info/     # ASIN情報API
│   │   ├── asin-upload/   # ASIN一括登録API
│   │   ├── asin-dangerous-goods/  # 危険物フラグAPI
│   │   ├── asin-partner-carrier/  # パートナーキャリア不可API
│   │   ├── brands/        # ブランド一覧API
│   │   └── proxy-status/  # プロキシ状態API
│   ├── dashboard/         # ダッシュボードページ
│   ├── shop/             # ショップページ
│   └── asin-upload/      # ASIN一括登録ページ
├── components/           # UIコンポーネント
│   ├── dashboard/        # ダッシュボード用
│   ├── layout/          # レイアウト
│   ├── product-list/    # 商品一覧用
│   │   ├── ProductTable.tsx           # メインテーブル
│   │   ├── ProductTableHeader.tsx     # テーブルヘッダー（並び替え対応）
│   │   ├── ProductTableRow.tsx        # テーブル行
│   │   ├── MultipleAsinManager.tsx    # 複数ASIN管理
│   │   ├── SearchAndFilter.tsx        # 検索・フィルター
│   │   ├── ScrapingButton.tsx         # スクレイピングボタン
│   │   ├── ProxyStatusIndicator.tsx   # プロキシ状態表示
│   │   └── UserDiscountControl.tsx    # ユーザー割引設定
│   └── ui/              # 基本UI
├── lib/                 # ユーティリティ・ライブラリ
│   ├── scrapers/        # スクレイピング処理
│   │   ├── common.ts    # 共通処理（プロキシ設定等）
│   │   └── official/    # 公式サイト用スクレイパー
│   ├── pricing-config.ts      # ショップ別価格設定
│   ├── pricing-calculator.ts  # 利益計算処理
│   ├── data-loader.ts         # データ読み込み処理
│   ├── fetchASINInfo.ts       # ASIN情報取得
│   ├── calc.ts               # 計算ユーティリティ
│   └── utils.ts              # 汎用ユーティリティ
├── hooks/               # カスタムフック
│   ├── useProductTable.ts         # 商品テーブル管理
│   └── useUserDiscountSettings.ts # ユーザー割引設定
├── types/               # TypeScript型定義
└── data/                # データファイル
    ├── products/        # 商品データ
    └── asin/           # ASINデータ
```

### 新しいショップの追加

1. **スクレイパー作成**: `src/lib/scrapers/` に新しいスクレイパーを追加
2. **価格設定**: `src/lib/pricing-config.ts` にショップ別価格計算ルールを追加
3. **API更新**: `src/app/api/scraping/` でスクレイピングエンドポイントを更新

## 💡 利益計算の詳細

### VT Cosmetics
```
仕入れ価格 = セール価格（または通常価格） - 400円
利益額 = Amazon販売価格 - 販売手数料 - FBA手数料 - 仕入れ価格
```

### DHC
```
基本割引 = セール価格 × 20%
ユーザー割引 = セール価格 × ユーザー設定%（0-50%）
仕入れ価格 = セール価格 - 基本割引 - ユーザー割引
利益額 = Amazon販売価格 - 販売手数料 - FBA手数料 - 仕入れ価格
```

### 利益指標
- **利益率**: `(利益額 / 入金額) × 100`
- **ROI**: `(利益額 / 仕入れ価格) × 100`

## 🔧 新機能詳細

### 複数ASIN管理
- **1商品複数ASIN**: 1つの商品に対して複数のASINを登録可能
- **個別利益計算**: 各ASINごとに利益額・利益率・ROIを自動計算
- **制約管理**: ASINごとに危険物・パートナーキャリア不可フラグを設定
- **展開表示**: ASIN一覧をクリックして詳細情報を確認
- **簡単削除**: 不要なASINは個別に削除可能

### テーブル機能強化
- **列幅調整**: 各列の境界をドラッグして幅を自由に調整
- **固定ヘッダー**: スクロール時もヘッダーが常に表示される
- **並び替え**: 列ヘッダークリックで昇順・降順切り替え
- **高度なフィルタリング**: 
  - 商品名・メモでの全文検索
  - 価格範囲指定（最小値〜最大値）
  - 危険物のみ表示
  - パートナーキャリア不可のみ表示
  - ASIN有無での絞り込み
  - 非表示商品の表示切り替え

### 制約フラグ管理
- **危険物**: FBA納品不可商品（赤色で表示）
- **パートナーキャリア不可**: パートナーキャリア利用不可商品（オレンジ色で表示、略称「ﾊﾟｰｷｬﾘ」）
- **両方該当**: グラデーション背景で表示
- **個別設定**: 各ASINごとに個別にフラグを設定可能

### エラーハンドリング強化
- **ASIN情報自動フォールバック**: データベースにASIN情報がない場合、基本情報を自動生成
- **手動入力ガイド**: 不完全なASIN情報に対する明確な入力ガイダンス
- **詳細エラー表示**: ユーザーにとって分かりやすいエラーメッセージ

## 🔍 トラブルシューティング

### よくある問題

#### ASIN登録エラー
1. **ASIN形式確認**: 10桁英数字の正しい形式か確認
2. **ネットワーク接続**: プロキシ設定とインターネット接続を確認
3. **手動入力**: ASIN情報が見つからない場合は手動で詳細情報を入力

#### プロキシ接続エラー
1. プロキシ設定の確認
2. 認証情報の確認
3. プロキシサーバーの稼働状況確認
4. `USE_PROXY=false` での直接接続テスト

#### スクレイピングエラー
1. プロキシ状態インジケーターで接続確認
2. 対象サイトのアクセス可能性確認
3. ブラウザコンソールでエラー詳細確認

#### データが表示されない
1. `src/data/products/` ディレクトリの存在確認
2. JSONファイルの形式確認
3. ファイル権限の確認

### ログ確認
```bash
# 開発サーバーのログ
npm run dev

# ブラウザコンソール
F12 → Console タブ
```

## 🚀 本番環境デプロイ

### Vercel（推奨）
```bash
# Vercel CLIインストール
npm i -g vercel

# デプロイ
vercel --prod
```

### 環境変数設定（Vercel）
```bash
vercel env add USE_PROXY
vercel env add PROXY_SERVER
vercel env add PROXY_USER
vercel env add PROXY_PASS
```

## 📊 パフォーマンス

### 最適化項目
- **SWRキャッシュ**: API レスポンスの効率的なキャッシュ
- **遅延読み込み**: 大量商品データの段階的読み込み
- **プロキシ切り替え**: 開発時の高速化
- **フィルタリング最適化**: useMemoによる結果キャッシュ
- **仮想スクロール**: 大量データ表示時のメモリ最適化（将来実装予定）

### 推奨スペック
- **メモリ**: 最小512MB、推奨1GB以上
- **ストレージ**: 最小1GB、推奨5GB以上
- **ネットワーク**: 安定したインターネット接続

## 🔒 セキュリティ

### データ保護
- **環境変数**: 機密情報の適切な管理
- **入力検証**: ASIN、価格データの厳密な検証
- **ファイル権限**: データファイルの適切な権限設定

### プロキシセキュリティ
- **認証**: ユーザー名・パスワード認証
- **暗号化**: HTTPS通信の使用
- **ログ管理**: 接続ログの適切な管理

## 📝 ライセンス

MIT License

## 🤝 コントリビューション

1. このリポジトリをフォーク
2. 機能ブランチを作成 (`git checkout -b feature/amazing-feature`)
3. 変更をコミット (`git commit -m 'Add amazing feature'`)
4. ブランチにプッシュ (`git push origin feature/amazing-feature`)
5. プルリクエストを作成

## 📞 サポート

問題や質問がある場合は、GitHubのIssuesページでお知らせください。

## 🆕 最新の更新内容

### v2.0.0 - 複数ASIN管理・テーブル機能強化
- ✅ **複数ASIN管理**: 1つの商品に対して複数のASINを登録・管理
- ✅ **パートナーキャリア不可フラグ**: 新しい制約フラグの追加
- ✅ **列幅調整**: テーブル列の幅をドラッグで自由に調整
- ✅ **固定ヘッダー**: スクロール時もヘッダーが表示
- ✅ **並び替え機能**: 列ヘッダークリックで昇順・降順切り替え
- ✅ **高度なフィルタリング**: 検索・価格範囲・各種フラグでの絞り込み
- ✅ **エラーハンドリング強化**: ASIN情報の自動フォールバック
- ✅ **色分け表示**: 危険物・パートナーキャリア不可の視覚的区別
- ✅ **手動入力ガイド**: 不完全なASIN情報の明確な表示